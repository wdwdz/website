---
title: "Nature Use Survey Analysis"
author: "Wangda Zhu"
date: "`r Sys.Date()`"
output:
   html_document:
     code_folding: hide
     theme: "spacelab"
     toc: TRUE
     toc_depth: 3
     toc_float: TRUE
     fig_height: 4
     fig_width: 4
     fig_align: 'center'
editor_options: 
  chunk_output_type: inline
---

```{css, echo=FALSE}
.scroll-100 {
  max-width: 700px;
  overflow-x: auto;
  background-color: inherit;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE, message=FALSE)
```

# DATA WRANGLING

This is a workflow of analyzing survey data from Qualtrics. When exporting data from Qualtrics, make sure to select "Use choice text" and "Split multi-value fields into columns" and export the data as csv file. 

After downloading the file, open it and delete the first **two rows** of the raw data. Now you should have the spreadsheet with only one row as its head. This will give convenience to further data wrangling in R. 

## Import useful libraries and read the raw data to R

```{r}
library(tidyverse)
library(vcd)
library(vcdExtra)
library(gmodels) #SPSS tables

raw<-read_csv("rawdata2.csv")
names(raw)<-str_replace_all(names(raw), c("#" = "."))
colnames(raw)[5]<-"Duration"
colnames(raw)[9]<-"Distribution"
raw$StartDate<-as.Date(raw$StartDate,format='%m/%d/%y')
```

## Filter the valid sample by progress, distribution, duration and startdate
```{r}
raw<-raw[raw$StartDate>"2020-11-23",]
raw<-raw[raw$Progress>70 & raw$Duration>180 & raw$Distribution != "preview",]
raw0<-raw

```

## 1 we create new dataframes for each multichoice questions and count the number of checked boxes
```{r}
#Q2.3 nature access
Q2.3<- raw %>% 
  select(contains( "Q2.3")) %>% 
  mutate(private=ifelse(is.na(Q2.3_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.3_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.3_5),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.3_7),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.3_8),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.3_9),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.3_10),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.3_11),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.3_14),0,1)) %>% 
  mutate(other=ifelse(is.na(Q2.3_14),0,1)) %>% 
  select(-contains("Q2.3")) %>% 
  mutate(access.score=private+deck+public+botanical+nature+woodland+river+lake+other)
Q2.3<-Q2.3 %>% 
  mutate(outdoorsathome=private+deck) %>% 
  mutate(outdoorsnearhome=(public+botanical+nature+woodland+river+lake+other)) %>% 
  mutate(divesitynearhome=ifelse(outdoorsnearhome>=3,1,0))

#Q2.4 nature use type before and after
Q2.4.before<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=ifelse(is.na(Q2.4.1_1_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.4.1_2_1),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.4.1_3_1),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.4.1_4_1),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.4.1_5_1),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.4.1_6_1),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.4.1_7_1),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.4.1_8_1),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.4.1_10_1),0,1)) %>% 
  select(-contains("Q2.4")) %>% 
  mutate(use.score.before=private+deck+public+botanical+nature+woodland+river+lake)

Q2.4.after<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=ifelse(is.na(Q2.4.1_1_2),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.4.1_2_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.4.1_3_2),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.4.1_4_2),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.4.1_5_2),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.4.1_6_2),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.4.1_7_2),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.4.1_8_2),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.4.1_10_2),0,1)) %>% 
  select(-contains("Q2.4")) %>% 
  mutate(use.score.after=private+deck+public+botanical+nature+woodland+river+lake)

#Q3.2 nature use activity before and after
Q3.2<- raw %>% 
  select(contains( "Q3.2")) %>% 
  mutate(social_before=ifelse(is.na(Q3.2_1_1),0,1)) %>% 
  mutate(social_during=ifelse(is.na(Q3.2_1_2),0,1)) %>% 
  mutate(lowintensity_before=ifelse(is.na(Q3.2_2_1),0,1)) %>% 
  mutate(lowintensity_during=ifelse(is.na(Q3.2_2_2),0,1)) %>% 
  mutate(highintensity_before=ifelse(is.na(Q3.2_3_1),0,1)) %>% 
  mutate(highintensity_during=ifelse(is.na(Q3.2_3_2),0,1)) %>% 
  mutate(restorative_before=ifelse(is.na(Q3.2_4_1),0,1)) %>% 
  mutate(restorative_during=ifelse(is.na(Q3.2_4_2),0,1)) %>% 
  mutate(others_before=ifelse(is.na(Q3.2_5_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q3.2_5_2),0,1)) %>% 
  select(-contains("Q3.2")) %>% 
  mutate(total_before=social_before + lowintensity_before + highintensity_before + restorative_before + others_before) %>% 
  mutate(total_during=social_during + lowintensity_during + highintensity_during + restorative_during + others_during) 

#Q3.3 nature use companion before and after
Q3.3<- raw %>% 
  select(contains( "Q3.3")) %>% 
  mutate(myself_before=ifelse(is.na(Q3.3_1_1),0,1)) %>% 
  mutate(myself_during=ifelse(is.na(Q3.3_1_2),0,1)) %>% 
  mutate(family_before=ifelse(is.na(Q3.3_2_1),0,1)) %>% 
  mutate(family_during=ifelse(is.na(Q3.3_2_2),0,1)) %>% 
  mutate(friends_before=ifelse(is.na(Q3.3_3_1),0,1)) %>% 
  mutate(friends_during=ifelse(is.na(Q3.3_3_2),0,1)) %>% 
  mutate(workmates_before=ifelse(is.na(Q3.3_4_1),0,1)) %>% 
  mutate(workmates_during=ifelse(is.na(Q3.3_4_2),0,1)) %>% 
  mutate(others_before=ifelse(is.na(Q3.3_5_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q3.3_5_2),0,1)) %>% 
  select(-contains("Q3.3")) %>% 
  mutate(total_before=myself_before + family_before + friends_before + workmates_before + others_before) %>% 
  mutate(total_during=myself_during + family_during + friends_during + workmates_during + others_during)

#Q4.2 nature use reason before and after
Q4.2<- raw %>% 
  select(contains( "Q4.2")) %>% 
  mutate(exercise_before=ifelse(is.na(Q4.2_1_1),0,1)) %>% 
  mutate(exercise_during=ifelse(is.na(Q4.2_1_2),0,1)) %>% 
  mutate(stressrelief_before=ifelse(is.na(Q4.2_2_1),0,1)) %>% 
  mutate(stressrelief_during=ifelse(is.na(Q4.2_2_2),0,1)) %>% 
  mutate(fun_before=ifelse(is.na(Q4.2_3_1),0,1)) %>% 
  mutate(fun_during=ifelse(is.na(Q4.2_3_2),0,1)) %>% 
  mutate(nature_before=ifelse(is.na(Q4.2_4_1),0,1)) %>% 
  mutate(nature_during=ifelse(is.na(Q4.2_4_2),0,1)) %>% 
  mutate(family_before=ifelse(is.na(Q4.2_5_1),0,1)) %>% 
  mutate(family_during=ifelse(is.na(Q4.2_5_2),0,1)) %>% 
  mutate(friends_before=ifelse(is.na(Q4.2_6_1),0,1)) %>%
  mutate(friends_during=ifelse(is.na(Q4.2_6_2),0,1)) %>%
  mutate(others_before=ifelse(is.na(Q4.2_7_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q4.2_7_2),0,1)) %>% 
  select(-contains("Q4.2")) %>% 
  mutate(total_before=exercise_before + stressrelief_before + fun_before + nature_before +friends_before + family_before+ others_before) %>% 
  mutate(total_during=exercise_during + stressrelief_during + fun_during + nature_during +friends_during + family_during+ others_during)

#Q4.5 nature access barriers
Q4.5<- raw %>% 
  select(contains( "Q4.5")) %>% 
  mutate(notime=ifelse(is.na(Q4.5_3),0,1)) %>% 
  mutate(noaccess=ifelse(is.na(Q4.5_4),0,1)) %>% 
  mutate(unsafe=ifelse(is.na(Q4.5_7),0,1)) %>% 
  mutate(noones=ifelse(is.na(Q4.5_8),0,1)) %>% 
  mutate(others=ifelse(is.na(Q4.5_9),0,1)) %>% 
  select(-contains("Q4.5")) %>% 
  mutate(total_barries=notime + noaccess + unsafe + noones + others) 

#Q5.6 nature work use activity
Q5.6<- raw %>% 
  select(contains( "Q5.6")) %>% 
  mutate(eat=ifelse(is.na(Q5.6_1),0,1)) %>% 
  mutate(walk=ifelse(is.na(Q5.6_2),0,1)) %>% 
  mutate(meet=ifelse(is.na(Q5.6_3),0,1)) %>% 
  mutate(rest=ifelse(is.na(Q5.6_4),0,1)) %>% 
  mutate(others=ifelse(is.na(Q5.6_5),0,1)) %>% 
  select(-contains("Q5.6")) %>% 
  mutate(total_campusoutdoors=eat + walk + meet + rest + others) 

#Q5.7 nature work access barrier
Q5.7<- raw %>% 
  select(contains( "Q5.7")) %>% 
  mutate(nointerest=ifelse(is.na(Q5.7_1),0,1)) %>% 
  mutate(notime=ifelse(is.na(Q5.7_2),0,1)) %>% 
  mutate(discouraged=ifelse(is.na(Q5.7_3),0,1)) %>% 
  mutate(noaccess=ifelse(is.na(Q5.7_4),0,1)) %>% 
  mutate(unappealing=ifelse(is.na(Q5.7_9),0,1)) %>% 
  mutate(noprotect=ifelse(is.na(Q5.7_10),0,1)) %>% 
  mutate(others=ifelse(is.na(Q5.7_11),0,1)) %>% 
  select(-contains("Q5.7")) %>% 
  mutate(total_barriers=nointerest+notime+discouraged+noaccess+unappealing+noprotect + others) 

#Q6.2 household
Q6.2<- raw %>% 
  select(contains( "Q6.2")) %>% 
  mutate(self=ifelse(is.na(Q6.2_10),0,1)) %>% 
  mutate(childpre=ifelse(is.na(Q6.2_1),0,1)) %>% 
  mutate(childele=ifelse(is.na(Q6.2_2),0,1)) %>% 
  mutate(youthmiddle=ifelse(is.na(Q6.2_3),0,1)) %>% 
  mutate(youthhigh=ifelse(is.na(Q6.2_4),0,1)) %>% 
  mutate(partner=ifelse(is.na(Q6.2_5),0,1)) %>% 
  mutate(parents=ifelse(is.na(Q6.2_6),0,1)) %>% 
  mutate(otherfamily=ifelse(is.na(Q6.2_7),0,1)) %>% 
  mutate(friend=ifelse(is.na(Q6.2_8),0,1)) %>% 
  mutate(others=ifelse(is.na(Q6.2_9),0,1)) %>% 
  select(-contains("Q6.2")) %>% 
  mutate(total_household=childpre+childele+youthhigh+youthmiddle+partner+parents+otherfamily+friend + others) %>% 
  mutate(children=(childpre==1|childele==1|youthmiddle==1|youthhigh==1)) 

# Q6.4 family outdoor activities
Q6.4<- raw %>% 
  select(contains( "Q6.4")) %>% 
  mutate(walking=ifelse(is.na(Q6.4_2),0,1)) %>% 
  mutate(running=ifelse(is.na(Q6.4_3),0,1)) %>% 
  mutate(kayaking=ifelse(is.na(Q6.4_5),0,1)) %>% 
  mutate(gardening=ifelse(is.na(Q6.4_6),0,1)) %>% 
  mutate(relaxing=ifelse(is.na(Q6.4_7),0,1)) %>% 
  mutate(camping=ifelse(is.na(Q6.4_9),0,1)) %>% 
  mutate(fishing=ifelse(is.na(Q6.4_10),0,1)) %>% 
  mutate(others=ifelse(is.na(Q6.4_11),0,1)) %>% 
  select(-contains("Q6.4")) %>% 
  mutate(total_familyoutdoors=walking+running+kayaking+gardening+relaxing+camping+fishing + others) 

```
## 2 we recode some variables and group them with the same measurement
```{r warning=FALSE}
#time natureQ2.4, Q2.6, Q2.7, Q2.8, Q2.10
timeoutdoors<- raw %>% 
  dplyr:: select(contains(c("2.5", "2.6", "2.7","2.8", "2.10"))) %>% 
  mutate_at(vars(1),function(x)(dplyr::recode(x,"7 days"=7, "4-6 days" = 5,
                                                "2-3 days" = 2.5,"1 day" = 1,
                                                "No days" = 0))) %>% 
  mutate_at(vars(2),function(x)(dplyr::recode(x,"More than 1 hr"=60, "31min - 1hr" = 45,
                                              "15-30 min" = 22.5,"Less than 15 min" = 7.5)))

#Q4.3 How you feel after time in nature
Q4.3<- raw %>% 
  select(contains("4.3")) %>% 
  mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                "Strongly disagree" = 1))) 
Q4.3$score=rowMeans(cbind(Q4.3$Q4.3_1,Q4.3$Q4.3_2,Q4.3$Q4.3_3,Q4.3$Q4.3_4,Q4.3$Q4.3_5),na.rm = TRUE)

#Q4.4 – How do you generally feel about nature
Q4.4<- raw %>% 
  select(contains("4.4")) %>% 
  mutate_at(vars(1:3),function(x)(dplyr::recode(x,"Not at all"=0, "Somewhat" = 1,
                                                "Definitely" = 3))) 
Q4.4$score=rowMeans(cbind(Q4.4$Q4.4_1,Q4.4$Q4.4_2,Q4.4$Q4.4_3),na.rm = TRUE)

#Q6.5 Spending time with family in nature
Q6.5<- raw %>% 
  select(contains("6.5")) %>% 
  mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                "Strongly disagree" = 1))) 
Q6.5$score=rowMeans(cbind(Q6.5$Q6.5_1,Q6.5$Q6.5_2,Q6.5$Q6.5_3),na.rm = TRUE)

Q7.7_access<- raw %>% 
  mutate(private=ifelse(is.na(Q2.3_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.3_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.3_5),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.3_7),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.3_8),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.3_9),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.3_10),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.3_11),0,1)) %>% 
  mutate(other=ifelse(is.na(Q2.3_13),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.3_14),0,1)) %>% 
  mutate(access.score=private+deck+public+botanical+nature+woodland+river+lake+other) %>% 
  select(contains("Q7.7"),access.score) 
Q7.7_access<- Q7.7_access %>% 
  mutate(neighborhood=dplyr::recode(Q7.7,"Larger city or urban center (e.g., Syracuse, NYC)"=5, 
                                              "Smaller city or urban center (e.g. Ithaca, Elmira)" = 4,
                                              "Suburb or just outside an urban center (e.g, Cayuga Heights, East Ithaca)" = 3,
                                              "Small town or village (e.g., Trumansburg, Lansing)" = 2,
                                              "Rural area" = 1))

# Q7.8 – Ethnicity / race
Q7.8<- raw %>% 
  select(contains( "Q7.8")) %>% 
  mutate(race2=case_when(is.na(Q7.8_1)==FALSE | is.na(Q7.8_2)==FALSE | is.na(Q7.8_3)==FALSE ~ "1",
                           is.na(Q7.8_4)==FALSE | is.na(Q7.8_5)==FALSE ~ "2",
                           is.na(Q7.8_6)==FALSE  ~ "3",
                           is.na(Q7.8_7)==FALSE  ~ "4",
                           is.na(Q7.8_8)==FALSE ~ "NA")) %>% 
  mutate(race1=case_when(is.na(Q7.8_1)==FALSE ~ "1",
                         is.na(Q7.8_2)==FALSE~ "2",
                         is.na(Q7.8_3)==FALSE~ "3",
                        is.na(Q7.8_4)==FALSE  ~ "4",
                        is.na(Q7.8_5)==FALSE~ "5",
                        is.na(Q7.8_6)==FALSE  ~ "6",
                        is.na(Q7.8_7)==FALSE  ~ "7",
                        is.na(Q7.8_8)==FALSE ~ "NA")) %>% 
  select(-contains("Q7.8")) %>% 
  mutate_if(is.character, as.factor)

```
## 3 we visulize some basic data
```{r warning=FALSE}
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(access.score))) +
  geom_bar(stat="count",position='dodge')
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsathome))) +
  geom_bar(stat="count",position='dodge') 
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsnearhome))) +
  geom_bar(stat="count",position='dodge') 
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(divesitynearhome))) +
  geom_bar(stat="count",position='dodge') 

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.7))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Weekend days – compared to weekdays ")

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.8))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Fall 2020 Vs April-July2020")

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.10))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Fall 2020 Vs Fall 2019")
Q3.2 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')
Q3.2 %>% 
  pivot_longer(social_before:others_during,
               names_to = "activity",
               values_to = "number") %>% 
  group_by(activity) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activity,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))

Q3.3 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')

Q3.3 %>% 
  pivot_longer(myself_before:others_during,
               names_to = "people",
               values_to = "number") %>% 
  group_by(people) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=people,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))
Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activities,y=number)) +
  geom_bar(stat="identity")


```

## 4 we visulize before and after multi choice questions, we take Q2.4 for example
```{r}
Q2.4<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=case_when(is.na(Q2.4.1_1_1)==TRUE & is.na(Q2.4.1_1_2)==TRUE ~ 1,
                           is.na(Q2.4.1_1_1)==TRUE & is.na(Q2.4.1_1_2)==FALSE ~ 2,
                           is.na(Q2.4.1_1_1)==FALSE & is.na(Q2.4.1_1_2)==TRUE ~ 3,
                           is.na(Q2.4.1_1_1)==FALSE & is.na(Q2.4.1_1_2)==FALSE ~ 4)) %>% 
  mutate(deck=case_when(is.na(Q2.4.1_2_1)==TRUE & is.na(Q2.4.1_2_2)==TRUE ~ 1,
                           is.na(Q2.4.1_2_1)==TRUE & is.na(Q2.4.1_2_2)==FALSE ~ 2,
                           is.na(Q2.4.1_2_1)==FALSE & is.na(Q2.4.1_2_2)==TRUE ~ 3,
                           is.na(Q2.4.1_2_1)==FALSE & is.na(Q2.4.1_2_2)==FALSE ~ 4)) %>% 
  mutate(public=case_when(is.na(Q2.4.1_3_1)==TRUE & is.na(Q2.4.1_3_2)==TRUE ~ 1,
                           is.na(Q2.4.1_3_1)==TRUE & is.na(Q2.4.1_3_2)==FALSE ~ 2,
                           is.na(Q2.4.1_3_1)==FALSE & is.na(Q2.4.1_3_2)==TRUE ~ 3,
                           is.na(Q2.4.1_3_1)==FALSE & is.na(Q2.4.1_3_2)==FALSE ~ 4)) %>% 
  mutate(botanical=case_when(is.na(Q2.4.1_4_1)==TRUE & is.na(Q2.4.1_4_2)==TRUE ~ 1,
                           is.na(Q2.4.1_4_1)==TRUE & is.na(Q2.4.1_4_2)==FALSE ~ 2,
                           is.na(Q2.4.1_4_1)==FALSE & is.na(Q2.4.1_4_2)==TRUE ~ 3,
                           is.na(Q2.4.1_4_1)==FALSE & is.na(Q2.4.1_4_2)==FALSE ~ 4)) %>% 
  mutate(nature=case_when(is.na(Q2.4.1_5_1)==TRUE & is.na(Q2.4.1_5_2)==TRUE ~ 1,
                           is.na(Q2.4.1_5_1)==TRUE & is.na(Q2.4.1_5_2)==FALSE ~ 2,
                           is.na(Q2.4.1_5_1)==FALSE & is.na(Q2.4.1_5_2)==TRUE ~ 3,
                           is.na(Q2.4.1_5_1)==FALSE & is.na(Q2.4.1_5_2)==FALSE ~ 4)) %>% 
  mutate(woodland=case_when(is.na(Q2.4.1_6_1)==TRUE & is.na(Q2.4.1_6_2)==TRUE ~ 1,
                           is.na(Q2.4.1_6_1)==TRUE & is.na(Q2.4.1_6_2)==FALSE ~ 2,
                           is.na(Q2.4.1_6_1)==FALSE & is.na(Q2.4.1_6_2)==TRUE ~ 3,
                           is.na(Q2.4.1_6_1)==FALSE & is.na(Q2.4.1_6_2)==FALSE ~ 4)) %>% 
  mutate(river=case_when(is.na(Q2.4.1_7_1)==TRUE & is.na(Q2.4.1_7_2)==TRUE ~ 1,
                           is.na(Q2.4.1_7_1)==TRUE & is.na(Q2.4.1_7_2)==FALSE ~ 2,
                           is.na(Q2.4.1_7_1)==FALSE & is.na(Q2.4.1_7_2)==TRUE ~ 3,
                           is.na(Q2.4.1_7_1)==FALSE & is.na(Q2.4.1_7_2)==FALSE ~ 4)) %>% 
  mutate(lake=case_when(is.na(Q2.4.1_8_1)==TRUE & is.na(Q2.4.1_8_2)==TRUE ~ 1,
                           is.na(Q2.4.1_8_1)==TRUE & is.na(Q2.4.1_8_2)==FALSE ~ 2,
                           is.na(Q2.4.1_8_1)==FALSE & is.na(Q2.4.1_8_2)==TRUE ~ 3,
                           is.na(Q2.4.1_8_1)==FALSE & is.na(Q2.4.1_8_2)==FALSE ~ 4)) %>% 
  mutate(none=case_when(is.na(Q2.4.1_10_1)==TRUE & is.na(Q2.4.1_10_2)==TRUE ~ 1,
                           is.na(Q2.4.1_10_1)==TRUE & is.na(Q2.4.1_10_2)==FALSE ~ 2,
                           is.na(Q2.4.1_10_1)==FALSE & is.na(Q2.4.1_10_2)==TRUE ~ 3,
                           is.na(Q2.4.1_10_1)==FALSE & is.na(Q2.4.1_10_2)==FALSE ~ 4)) %>% 
  select(-contains("Q2.4"))

Q2.4 %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "change") %>% 
  mutate(change=factor(change,labels = c("NbeforeNnow", "beforeNnow","Nbeforenow","beforenow"))) %>% 
  ggplot(mapping = aes(x=place,fill=change)) +
    geom_bar(stat="count",position='dodge')
Q2.4.score<-cbind(Q2.4.before,Q2.4.after)

Q2.4.score %>% 
  select(use.score.before,use.score.after) %>% 
  pivot_longer(use.score.before:use.score.after,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=factor(time,levels = c("use.score.before","use.score.after")))) +
  geom_bar(stat="count",position='dodge')+
  guides(fill=guide_legend(title="Time"))+ 
  ggtitle("Plot of total types of place use before and after COVID")

Q2.4.before<-Q2.4.before %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "use") %>% 
  group_by(place) %>%
  dplyr::summarise(se = sd(use)/sqrt(483),total = sum(use)) %>% 
  mutate(time="before")


Q2.4.after<-Q2.4.after %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "use") %>% 
  group_by(place) %>%
  dplyr::summarise(se = sd(use)/sqrt(483),total = sum(use)) %>% 
  mutate(time="after")

Q2.4.sum<-rbind(Q2.4.before,Q2.4.after)
levels<-unique(Q2.4.sum$place)
Q2.4.sum$place<-factor(Q2.4.sum$place,levels = c("botanical","deck","lake","nature","private","public","river","woodland","none"))
Q2.4.sum %>% 
  ggplot(mapping = aes(x=place,y=total/483,fill=factor(time,levels = c("before","after")))) +
  geom_bar(stat="identity",position='dodge')+
  geom_errorbar(aes(ymin=total/483-se, ymax=total/483+se), width=.5,
                position=position_dodge(.9)) +
  ylab("proportion")+
  guides(fill=guide_legend(title="Time"))+ 
  ggtitle("Plot of place use before and after COVID")

###Let's focus on the change: who change most after covid?
Q2.4.score %>% 
  select(use.score.before,use.score.after) %>%
  mutate(change=use.score.after-use.score.before) %>% 
  select(change) %>% 
  mutate(id = row_number()) %>% 
  ggplot(mapping = aes(x = id,y=change))+
  geom_bar(stat = "identity")

Q2.4_demo<-Q2.4.score %>% 
  select(use.score.before,use.score.after) %>%
  mutate(change=use.score.after-use.score.before) %>% 
  select(change) %>% 
  mutate(id = row_number()) %>% 
  mutate(largechange=ifelse(change>2 | change <(-2),1,0)) %>% 
  mutate(changedirection=case_when(change>0~"positive",
                                   change==0~"nochange",
                                   change<0~"negative")) %>% 
  cbind("neighborhood"=raw$Q7.7) %>% 
  cbind("gender"= raw$Q7.2) %>% 
  cbind("workplace"=raw$Q5.3) %>% 
  cbind("workyear"= raw$Q7.3)


Q2.4_demo %>% ggplot(mapping = aes(x=neighborhood,fill=factor(largechange)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=neighborhood,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=gender,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=workplace,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")+
  theme(axis.text.x = element_text(size=10,angle = 20,hjust=.5,vjust=.5,face="plain"))
Q2.4_demo %>% ggplot(mapping = aes(x=workyear,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")+
  theme(axis.text.x = element_text(size=10,angle = 20,hjust=.5,vjust=.5,face="plain"))

```

## 5 we do basic correlation calculation for continous, ordinal and binary data, there are different sorts of correlations between different types of variables
```{r warning=FALSE}
#correlatio between spend time outdoors during the workday,
#gender(0/1), how long at cornell, neighborhood type,
#household total, children, feel1, feel2, work barriers total, 
#time in nature, spend time outdoors during the workday
raw$Q5.2<-dplyr::recode(raw$Q5.2,"0 days"=0, "1 day"  = 1,
              "2-3 days" = 2,"4-5 days" = 3) 
raw$Q7.2<-dplyr::recode(raw$Q7.2,"Female"=0, "Male"  = 1)
raw$Q7.3<-dplyr::recode(raw$Q7.3,"Less than 2 years"=0, 
                        "More than 2 but less than 5 years"  = 1,
                        "More than 5 but less than 10 years" = 2,
                        "10 or more years" =3)
raw$Q7.7<-dplyr::recode(raw$Q7.7,"Larger city or urban center (e.g., Syracuse, NYC)"=1, 
                 "Smaller city or urban center (e.g. Ithaca, Elmira)" = 1,
                 "Suburb or just outside an urban center (e.g, Cayuga Heights, East Ithaca)" = 0,
                 "Small town or village (e.g., Trumansburg, Lansing)" = 0,
                 "Rural area" = 0)
Q6.2<- raw %>% 
    select(contains( "Q6.2")) %>% 
    mutate(self=ifelse(is.na(Q6.2_10),0,1)) %>% 
    mutate(childpre=ifelse(is.na(Q6.2_1),0,1)) %>% 
    mutate(childele=ifelse(is.na(Q6.2_2),0,1)) %>% 
    mutate(youthmiddle=ifelse(is.na(Q6.2_3),0,1)) %>% 
    mutate(youthhigh=ifelse(is.na(Q6.2_4),0,1)) %>% 
    mutate(partner=ifelse(is.na(Q6.2_5),0,1)) %>% 
    mutate(parents=ifelse(is.na(Q6.2_6),0,1)) %>% 
    mutate(otherfamily=ifelse(is.na(Q6.2_7),0,1)) %>% 
    mutate(friend=ifelse(is.na(Q6.2_8),0,1)) %>% 
    mutate(others=ifelse(is.na(Q6.2_9),0,1)) %>% 
    select(-contains("Q6.2")) %>% 
    mutate(total_household=childpre+childele+youthhigh+youthmiddle+partner+parents+otherfamily+friend + others) %>% 
    mutate(children=(childpre==1|childele==1|youthmiddle==1|youthhigh==1)) 
Q6.2$children<-ifelse(Q6.2$children==TRUE,1,0)
Q4.3<- raw %>% 
    select(contains("4.3")) %>% 
    mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                  "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                  "Strongly disagree" = 1))) 
Q4.3$score=rowMeans(cbind(Q4.3$Q4.3_1,Q4.3$Q4.3_2,Q4.3$Q4.3_3,Q4.3$Q4.3_4,Q4.3$Q4.3_5),na.rm = TRUE)
Q4.4<- raw %>% 
    select(contains("4.4")) %>% 
    mutate_at(vars(1:3),function(x)(dplyr::recode(x,"Not at all"=0, "Somewhat" = 1,
                                                  "Definitely" = 3))) 
Q4.4$score=rowMeans(cbind(Q4.4$Q4.4_1,Q4.4$Q4.4_2,Q4.4$Q4.4_3),na.rm = TRUE)
Q5.7<- raw %>% 
    select(contains( "Q5.7")) %>% 
    mutate(nointerest=ifelse(is.na(Q5.7_1),0,1)) %>% 
    mutate(notime=ifelse(is.na(Q5.7_2),0,1)) %>% 
    mutate(discouraged=ifelse(is.na(Q5.7_3),0,1)) %>% 
    mutate(noaccess=ifelse(is.na(Q5.7_4),0,1)) %>% 
    mutate(unappealing=ifelse(is.na(Q5.7_9),0,1)) %>% 
    mutate(noprotect=ifelse(is.na(Q5.7_10),0,1)) %>% 
    mutate(others=ifelse(is.na(Q5.7_11),0,1)) %>% 
    select(-contains("Q5.7")) %>% 
    mutate(total_barriers=nointerest+notime+discouraged+noaccess+unappealing+noprotect + others) 

raw$Q2.5<-dplyr::recode(raw$Q2.5,"7 days"=4, "4-6 days" = 3,
                                            "2-3 days" = 2,"1 day" = 1,
                                            "No days" = 0)
raw$Q2.6<-dplyr::recode(raw$Q2.6,"More than 1 hr"=3, "31min - 1hr" = 2,
                                  "15-30 min" = 1,"Less than 15 min" = 0)
df.cor<-as.data.frame(cbind(raw$Q5.2,raw$Q7.2,raw$Q7.3,raw$Q7.7,Q6.2$total_household,Q6.2$children,Q4.4$score,Q4.3$score,Q5.7$total_barriers,raw$Q2.5,raw$Q2.6))
colnames(df.cor)<-c("out_week","gender","workyrs","neighbor","household","children","naturefeel","nature_after_feel","barriers","week_out","out_time")
round(cor(df.cor,use="pairwise.complete.obs"),digits =3)
ltm::rcor.test(df.cor,use="pairwise.complete.obs")

```
## 6 we do basic statistic tests for norminal,ordinal and binary data such as chi2 test
```{r warning=FALSE}
# Q1
#CORRELATION BETWEEN ORDINAL AND ORDINAL
#                    ORDINAL AND NORMINAL
#                    NORMINAL AND NORMINAL
#1. CHI-2 TEST CAN BE USED
# We check space use and space access

df.chi<-Q2.3 %>% 
  select(access.score,outdoorsathome,outdoorsnearhome,divesitynearhome) %>% 
  mutate(access.score=as.factor(access.score)) %>% 
  rename(access=access.score) %>% 
  mutate(outdoorsathome=as.factor(outdoorsathome)) %>% 
  mutate(outdoorsnearhome=as.factor(outdoorsnearhome)) %>% 
  mutate(divesitynearhome=as.factor(divesitynearhome)) %>% 
  cbind("use.types.before"=as.factor(Q2.4.score$use.score.before)) %>% 
  cbind("use.types.after"=as.factor(Q2.4.score$use.score.after)) %>% 
  cbind("neighborhood"=as.factor(raw$Q7.7)) %>% 
  cbind("gender"= as.factor(raw$Q7.2)) %>% 
  cbind("workyear"= as.factor(raw$Q7.3)) %>% 
  cbind("use.activities.before"= as.factor(Q3.2$total_before)) %>% 
  cbind("use.activities.after"= as.factor(Q3.2$total_during)) %>% 
  cbind("use.companions.before"= as.factor(Q3.3$total_before)) %>% 
  cbind("use.companions.after"= as.factor(Q3.3$total_during)) %>%
  cbind("time.daysperweek"=as.factor(raw$Q2.5)) %>% 
  cbind("time.hourspertime"=as.factor(raw$Q2.6)) %>% 
  cbind("race1"=Q7.8$race1) %>% 
  cbind("race2"=Q7.8$race2)


  
#access  
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -1], MoreArgs=list(df.chi[,1]))
#outdoorsathome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -2], MoreArgs=list(df.chi[,2]))
#outdoorsnearhome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -3], MoreArgs=list(df.chi[,3]))
#divesitynearhome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -4], MoreArgs=list(df.chi[,4]))
#neighborhood
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -7], MoreArgs=list(df.chi[,7]))
#gender
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -8], MoreArgs=list(df.chi[,8]))
#time week
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -14], MoreArgs=list(df.chi[,14]))
#time hour
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -15], MoreArgs=list(df.chi[,15]))

# We check work/campus based space use

df.chi2<-Q5.6 %>% 
  select(total_campusoutdoors) %>% 
  mutate(total_campusoutdoors=as.factor(total_campusoutdoors)) %>% 
  cbind("timeinworkday"=as.factor(raw$Q5.2)) %>% 
  cbind("use.types.before"=as.factor(Q2.4.score$use.score.before)) %>% 
  cbind("use.types.after"=as.factor(Q2.4.score$use.score.after)) %>% 
  cbind("neighborhood"=as.factor(raw$Q7.7)) %>% 
  cbind("gender"= as.factor(raw$Q7.2)) %>% 
  cbind("workyear"= as.factor(raw$Q7.3)) %>% 
  cbind("use.activities.before"= as.factor(Q3.2$total_before)) %>% 
  cbind("use.activities.after"= as.factor(Q3.2$total_during)) %>% 
  cbind("use.companions.before"= as.factor(Q3.3$total_before)) %>% 
  cbind("use.companions.after"= as.factor(Q3.3$total_during)) %>%
  cbind("time.daysperweek"=as.factor(raw$Q2.5)) %>% 
  cbind("time.hourspertime"=as.factor(raw$Q2.6)) %>% 
  cbind("race1"=Q7.8$race1) %>% 
  cbind("race2"=Q7.8$race2)

#total_campusoutdoors
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi2[, -1], MoreArgs=list(df.chi2[,1]))
#timeinworkday
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi2[, -2], MoreArgs=list(df.chi2[,2]))


#2. TO CALCULATE THE COEFFICIENT: 
# Q2
#CORRELATION BETWEEN CONTINOUS VARIABLE AND ORDINAL, OR NORMINAL? 
#1. TO CALCULATE THE COEFFICENT:
#2. NEED THE ASSUMPTION THAT CONTINOUS VARIABLE IS NORMAL DISTRIBUTED?
                    
#correlation between continous and ordinal variables:
#Spearman correlation


#correlation between continous and categorical variables:
#point-biserial correlation 
#linear model


#correlation between continous and continous variables:
#pearson correlation


#correlation between ordinal and ordinal variables:
#Spearman rank correlation 


#correlation between ordinal and norminal variables:
#rank-biserial  correlation  


#correlation between norminal and norminal variables:
#Phi Correlation Coefficient
#chi2 test


```
## 7 we do reliability test for likert data
```{r}
psy::cronbach(Q4.3[,1:5])
psy::cronbach(Q4.4[,1:3])

```
## 8 we do more complex data modeling like factor analysis and structural equation modeling
```{r}
# library(lavaan)   
# library(lavaanPlot)
# 
# data.cfa<-as.data.frame(cbind(raw$Q7.7,Q5.7$total_barriers,Q2.3$access.score,Q4.3$score,Q4.4$score,Q4.2$total_before,Q4.2$total_during,Q3.2$total_before,Q3.3$total_before,Q2.4.before$use.score.before,Q3.2$total_during,Q3.3$total_during,Q2.4.after$use.score.after))
# colnames(data.cfa)<-c("nei_type","barrier","access_type","feel_nature","feel_afteruse","reason_bafore","reason_during","before_activity","before_companion","before_type","after_activity","after_companion","after_type")
# data.cfa$feel_afteruse<-round(data.cfa$feel_afteruse,1)
# 
# data.cfa<-na.omit(data.cfa)
#     
# cfa.model <- '
#               attitudes =~ feel_afteruse+feel_nature+reason_bafore+reason_during
#               usebefore =~ before_activity+before_companion+before_type
#               useafter =~ after_activity+after_companion+after_type
#               
#                before_type ~~       after_type 
#               feel_afteruse ~~      feel_nature
#               before_activity ~~   after_activity
#               
#                 '
# fit2_CFA <- cfa(cfa.model, data = data.cfa)
# modindices(fit2_CFA, minimum.value = 3.841, sort=TRUE, free.remove = FALSE)
# fitmeasures(fit2_CFA, c("chisq","df","pvalue","gfi","agfi","nfi","nnfi","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper","rmsea.pvalue","srmr", "ave"))
# lavaanPlot(model = fit2_CFA, coefs = TRUE, stand=TRUE)




```
# ANALYSIS
<p style="color:red">The statisctic methods used in this part mainly include:</p> 
Cochran-Mantel-Haenszel statistics (Landis etal., 1978)<br>
a. CMH correlation statistic ("cor"), treating both factors as ordered. b. The ANOVA (row mean scores and column mean scores) statistics, treat the columns and rows respectively as ordinal, and are sensitive to mean shifts over columns or rows. c. general association statistic treat both factors as unordered, and give a test closely related to the Pearson χ^2 test. <br>
Fisher test: when the value in any cell is smaller than 5, Fisher test is recommended. <br>
For a 3+ way table, one table of CMH tests is produced for each combination of the factors identified as strata. If overall=TRUE, an additional table is calculated for the same two primary variables, controlling for (pooling over) the strata variables.
These overall tests implicitly assume no interactions between the primary variables and the strata and they will have low power in the presence of interactions.<br>
Sieve diagram <br>
Riedwyl and Schüpbach (1983, 1994) proposed a sieve diagram (later called a parquet diagram ) based on this principle. In this display the area of each rectangle is proportional to expected frequency and observed frequency is shown by the number of squares in each rectangle. Hence, the difference between observed and expected frequency appears as the density of shading, using color to indicate whether the deviation from independence is positive or negative.<br>
Paired-T test<br>
Test if the within subject change is significant of not. The paired sample t-test has four main assumptions: The dependent variable must be continuous (interval/ratio). The observations are independent of one another. The dependent variable should be approximately normally distributed. The dependent variable should not contain any outliers.

![Relationship framework.](framework.png)



## 1 Access
<span style="background-color: #FFFF00">a. What kind of outdoor/natural spaces do people have access to (Q2.3)? <br>
b.what quantity and level of diversity (ie higher quantity of spaces) of access do they have Q2.3)?</span>

Access has 4 veriables in this survey:<br>
ACCESS TOTAL: total number of spaces a person can access <br>
OUTDOORS AT HOME: whether a person's home has 'private or shared yard’ and ‘deck balcony or patio’ <br>
OUTDOORS NEAR HOME: total number of spaces that near home a person can access<br>
DIVERSITY NEAR HOME: whether a person can access 3 or more than 3 ourdoors near home spaces.

```{r}
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(access.score))) +
  geom_bar(stat="count",position='dodge')+
  ggtitle("Accesstotal")
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsathome))) +
  geom_bar(stat="count",position='dodge') +
  ggtitle("outdoorsathome")
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsnearhome))) +
  geom_bar(stat="count",position='dodge') +
  ggtitle("outdoorsnearhome")
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(divesitynearhome))) +
  geom_bar(stat="count",position='dodge')  +
  ggtitle("diversitynearhome")

```


<span style="background-color: #FFFF00">c. Does access (multiple variables) correlate with type of home setting (Q7.7)</span> <br>
<span style="color:red">The analysis part is below:</span> <br>
Neighbortype: types of neigborhood a person lives. It has 5 levels. We can regard it as a categorical variable without any order or a ordinal variable which has an order from rural area to large city. The levels of this is shown in the first block below. <br>
The second block is the contingency table of neighbortype x accesstotal. The third block is CMH test on the contingency table. The first test <span style="color:red">cor</span> treats both factors as ordered, the same as Spearman rank correlation; the second and third tests <span style="color:red">rmeans and cmeans</span> treat columns and rows as ordered, the same as ANOVA tests. The last test <span style="color:red">general</span> treats both factors as non-ordered and gives the Chi-2 test result. <br>
The rest blocks are contigency tables of each Access variable x neighbortype variable and their CMH test results accordingly. <br>
The last block is <span style="color:red">Sieve Diagram</span>. Blue color means the cell has more count than expected if there is no correlation between the two factors. Red color means fewer counts. From this diagram, we could find the negative correlation between outdoorsathome and neighbortype. <br>
In summary, Outdoorsathome and neighbortype are highly correlated: urban neighborhood and number of types of ourdoorsathome are signifiacantly negative correlated. <br>
Other correlation relations are not very clear.
We notice some cell has very few count values. However, even if we combine those cells together, i.e.  we combine the last twe levels of neighbortype: small city and large city together, the significance level doesn't change.

```{r}
df.chi<- df.chi %>% 
    cbind("neighbortype"=as.factor(Q7.7_access$Q7.7)) %>% 
    cbind("accessscore"= as.factor(Q7.7_access$access.score))
colnames(df.chi)[19]<-"accesstotal"

df.chi$neighbortype<-factor(df.chi$neighbortype,levels = c("Rural area","Small town or village (e.g., Trumansburg, Lansing)" ,"Suburb or just outside an urban center (e.g, Cayuga Heights, East Ithaca)","Smaller city or urban center (e.g. Ithaca, Elmira)" ,"Larger city or urban center (e.g., Syracuse, NYC)"), labels = c("Rurl","Smlltwn","Sbrb","Smllcty","Lrgcty"))
levels(df.chi$neighbortype)
Q1.1<-xtabs(~accesstotal + neighbortype,data=df.chi)
Q1.1
CMHtest(Q1.1)
Q1.2<-xtabs(~outdoorsathome + neighbortype,data=df.chi)
Q1.2
CMHtest(Q1.2)
Q1.3<-xtabs(~outdoorsnearhome + neighbortype,data=df.chi)
Q1.3_nlarge = Q1.3[-8,-5]
Q1.3
Q1.3_nlarge
CMHtest((Q1.3_nlarge))
dtry<-as.data.frame(Q1.3_nlarge)
#ggplot(data = df.chi,aes(neighbortype,as.numeric(outdoorsnearhome)))+
#  geom_boxplot()
Q1.4<-xtabs(~divesitynearhome + neighbortype,data=df.chi)
CMHtest((Q1.4))
Q1.2
CrossTable(Q1.2,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")
sieve(Q1.2,shade = TRUE)


```

<span style="background-color: #FFFF00">c1. Is access a moderator b/w use or time outdoors and neighborhood type?</span> <br>

For this question, I will check the moderator effect later, I am checking the a sub question here: <br>

What is the relationship between time outdoors and neighborhood type? <br>
Time has two variables:<br>
Time.daysperweek:
The level of days go outside every week.
Time.hourspertime: <br>
The level of hours go outside each time.

There is correlation between time of ourtdoors perweek and neighborhood type. The Sieve diagram shows the pattern. We do Fisher test here as some cells have fewer than 5 counts. But no matter what test we do, no matter we treat the 2 factors as ordinal or catigorical variables, the correlations are significant. <br>
The analysis part is blow:


```{r}

Q2.1<-xtabs(~neighbortype+time.daysperweek,data = df.chi)
CMHtest(Q2.1)
sieve(Q2.1,shade = TRUE)
Q2.2<-xtabs(~neighbortype+time.hourspertime,data = df.chi)
CMHtest(Q2.2)
sieve(Q2.2,shade=TRUE)
#Q2_gender<-xtabs(~neighbortype+time.daysperweek+gender,data = df.chi)
#assocstats(Q2_gender)
#chisq.test(table(df.chi$neighbortype,df.chi$time.daysperweek))
fisher.test(Q2.1,simulate.p.value=TRUE,B=1e5)
fisher.test(Q2.2,simulate.p.value = TRUE,B=1e5)
```

<span style="background-color: #FFFF00">d. Does access at or near home OR diversity of spaces near home correlate to TOTAL TIME outdoors (in any of the 3 time periods)</span> <br>

The time.daysperweek is highly correlated with each variable of access. <br>
The analysis part is below:

```{r}
Q1.d1<-xtabs(~outdoorsathome+time.daysperweek,data = df.chi)
CMHtest(Q1.d1)
Q1.d2<-xtabs(~outdoorsathome+time.hourspertime,data = df.chi)
CMHtest(Q1.d2)
sieve(Q1.d1,shade=TRUE)
Q1.d3<-xtabs(~outdoorsnearhome+time.daysperweek,data = df.chi)
CMHtest(Q1.d3)
sieve(Q1.d3,shade=TRUE)
Q1.d4<-xtabs(~outdoorsnearhome+time.hourspertime,data = df.chi)
CMHtest(Q1.d4)
Q1.d5<-xtabs(~divesitynearhome+time.daysperweek,data = df.chi)
CMHtest(Q1.d5)
sieve(Q1.d5,shade=TRUE)
Q1.d6<-xtabs(~divesitynearhome+time.hourspertime,data = df.chi)
CMHtest(Q1.d6)
sieve(Q1.d6,shade=TRUE)
```


## 2 Use
<span style="background-color: #FFFF00">a. Use change pre to post covid within subjects significant?</span> <br>
Use (Q2.4) include use score before: total number of outdoors places a person use before COVID;<br>
use score after: total number of outdoors places a person use during COVID.<br>
We use paired-test and treat the total number of types of place used as a continous variable. The test showed after COVID, space use is significantly less, but the significance is marginal. (0.19, p = 0.03).

```{r}
res <- t.test(Q2.4.score$use.score.before, Q2.4.score$use.score.after, paired = TRUE)
res

boxplot(Q2.4.score$use.score.before, Q2.4.score$use.score.after)
```

<span style="background-color: #FFFF00">b. Use change pre to post covid of different places in total significant?</span> <br>

I am not very confident in this analysis here. In the analysis below, I treat any person using each place or not follows the same distribution and add error bars for the total use of each place. However, I am not sure if this assumption is valid in this analysis.

```{r}
Q2.4.sum %>% 
  ggplot(mapping = aes(x=place,y=total/483,fill=factor(time,levels = c("before","after")))) +
  geom_bar(stat="identity",position='dodge')+
  geom_errorbar(aes(ymin=total/483-se, ymax=total/483+se), width=.5,
                position=position_dodge(.9)) +
  ylab("proportion")+
  guides(fill=guide_legend(title="Time"))+ 
  ggtitle("Plot of place use before and after COVID")
```

<span style="background-color: #FFFF00">c.	Does access relate to use? </span> <br>

Here, we test the correlation between the 4 access variables with total number of used places before and after- 8 correlations. <br>
We found all correlations are significant.
```{r}
Q2.c1<-xtabs(~df.chi$outdoorsathome+Q2.4.score$use.score.before)
Q2.c1
CMHtest(Q2.c1)
Q2.c2<-xtabs(~df.chi$outdoorsathome+Q2.4.score$use.score.after)
CMHtest(Q2.c2)
sieve(Q2.c2,shade=TRUE)
Q2.c3<-xtabs(~df.chi$outdoorsnearhome+Q2.4.score$use.score.before)
CMHtest(Q2.c3)
Q2.c4<-xtabs(~df.chi$outdoorsnearhome+Q2.4.score$use.score.after)
CMHtest(Q2.c4)
Q2.c5<-xtabs(~df.chi$divesitynearhome+Q2.4.score$use.score.before)
CMHtest(Q2.c5)
Q2.c6<-xtabs(~df.chi$divesitynearhome+Q2.4.score$use.score.after)
CMHtest(Q2.c6)
Q2.c7<-xtabs(~df.chi$accesstotal+Q2.4.score$use.score.before)
CMHtest(Q2.c7)
Q2.c8<-xtabs(~df.chi$accesstotal+Q2.4.score$use.score.after)
CMHtest(Q2.c8)


```


<span style="background-color: #FFFF00">d.Time outdoors since covid emerged (Q2.8) and in Fall 2019 (Q2.10) </span> <br>

```{r, class.output="scroll-100"}
raw %>% 
  ggplot(mapping = aes(x=Q2.8))+
  geom_bar()+
  ggtitle("time outdoors since covid emerged")
raw %>% 
  ggplot(mapping = aes(x=Q2.10))+
  geom_bar()+
  ggtitle("time outdoors in Fall 2019")


CrossTable(raw$Q2.8,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")
CrossTable(raw$Q2.10,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")

```

 <span style="background-color: #FFFF00">e.	Does time outdoors in workday and time in general correlate with any of the following: </span> <br>

i.	Gender (Q7.2)
ii.	Neighborhood type (Q7.7)
iii.	Race (7.8)
iv.	Race category (new variable from 7.8)
v.	HOME BARRIERS TOTAL (new variable)
vi.	People in the household : HOUSEHOLD TOTAL, CHILDREN, SENIORS or FAMILY
vii.	TOTAL COMPANIONS
viii.	FEEL ABOUT NATURE TOTAL
ix.	FEEL AFTER NATURE TOTAL <br>

out_week: time outdoors in workday <br>
week_out: days outdoors in week<br>
out_time: time outdoor per time<br>
For the correlation table, the assumption is to treated all variables as ordinal variables. It makes sense for binary variables like gender, counts like total number, scale scores like feel about nature total; but NOT for categorical variables like race. For some variables like neighborhood type, it may make sense. The correlation is calculates as Spearman Correlation. <br>
But we need to be caustious on this correlation table as i am not very clear about the calculation now: some tests are not significant in chi2 test but significant here and I do not know the reason.

```{r, class.output="scroll-100"}
df.cor<-as.data.frame(cbind(raw$Q5.2,raw$Q7.2,raw$Q7.3,raw$Q7.7,Q6.2$total_household,Q6.2$children,Q4.4$score,Q4.3$score,Q5.7$total_barriers,raw$Q2.5,raw$Q2.6))
colnames(df.cor)<-c("out_week","gender","workyrs","neighbor","household","children","naturefeel","nature_after_feel","barriers","week_out","out_time")
#round(cor(df.cor,use="pairwise.complete.obs"),digits =3)
ltm::rcor.test(df.cor,use="pairwise.complete.obs")



```

## 3 Work
<span style="background-color: #FFFF00">a. Did staff typically spend time outdoors during the workday (Q5.2)? </span> <br>

```{r}
raw0 %>% 
  ggplot(mapping = aes(x=Q5.2))+
  geom_bar()+
  ggtitle("staff typically spend time outdoors during the workday")

CrossTable(raw$Q5.2,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")

```
<span style="background-color: #FFFF00">b. what did they typically do (Q5.6)</span> <br>

```{r}
Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activities,y=number)) +
  geom_bar(stat="identity")

Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum) %>% 
  select(activities,number)
```
<span style="background-color: #FFFF00">c. Use in general and on campus correlation with: </span> <br>

i.	gender
ii.	how long worked at Cornell (Q7.3)
iii.	type of employment (Q7.4 and 7.5)
iv.	work outdoors (Q7.6)
v.	neighborhood type (7.7)
vi.	race (7.8)
vii.	race category (new variable from 7.8)
viii.	HOUSEHOLD TOTAL
ix.	CHILDREN
x.	SENIORS
xi.	FAMILY
xii.	FEEL ABOUT NATURE TOTAL
xiii.	FEEL AFTER NATURE TOTAL
xiv.	WORK BARRIERS TOTAL (new variable)
xv.	TOTAL CAMPUS ACTIVITY <br>

total_campusoutdoors: Q5.6 total places use on campus<br>
use.types.before: Q2.4 total places use before COVID<br>
use.types.after: Q2.4 total places use during COVID<br>
use.activities.before: Q3.2 total number of activities outdoors before COVID <br>
use.companions.before:3.3 total number of types of companions outdoors before COVID <br>

```{r, class.output="scroll-100"}
ltm::rcor.test(df.chi2,use="pairwise.complete.obs")
```
<span style="background-color: #FFFF00">d. More or less time outdoors than when working from home? </span> <br>

```{r}
raw %>% 
  ggplot(mapping = aes(x=Q5.4))+
  geom_bar()+
  ggtitle("More or less time outdoors than when working from home")
CrossTable(raw$Q5.4,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")
```


<span style="background-color: #FFFF00">e. More or less than on campus pre-covid (Q5.5) </span> <br>

```{r}
raw %>% 
  ggplot(mapping = aes(x=Q5.5))+
  geom_bar()+
  ggtitle("More or less than on campus pre-covid")
CrossTable(raw$Q5.5,prop.chisq = FALSE,prop.c=FALSE,format = "SPSS")


```


## 4 Barrier
<span style="background-color: #FFFF00">a.	Overview of barriers </span> <br>


```{r}
Q5.7 %>% 
  pivot_longer(nointerest:others,
               names_to = "barriers",
               values_to = "number") %>% 
  group_by(barriers) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=barriers,y=number)) +
  geom_bar(stat="identity")

Q5.7.sum<-Q5.7 %>% 
  pivot_longer(nointerest:others,
               names_to = "barriers",
               values_to = "number") %>% 
  group_by(barriers) %>% 
  summarise_all(sum) %>% 
  select(barriers,number)

Q5.7.sum




```

<span style="background-color: #FFFF00">b.	Time (both) is correlated with total barriers – very interesting – dig a bit deeper in relation to barriers – do barriers change by nbhd type? Gender? Attitudes towards nature?<br>
b1. Time.daysperweek and Time.hourspertime and total barriers: </span> <br>

Time.daysperweek NOT correlated with total barriers;<br>
Time.hourspertime and total barriers are correlated with marginal significance. 

```{r}
Q4.b1<-xtabs(~df.chi$time.daysperweek+Q5.7$total_barriers)
CMHtest(Q4.b1)
Q4.b2<-xtabs(~df.chi$time.hourspertime+Q5.7$total_barriers)
CMHtest(Q4.b2)
Q4.b2
fisher.test(Q4.b2,simulate.p.value=TRUE,B=1e5)
CMHtest(Q4.b2[-1,c(-5,-6)])
sieve(Q4.b2[-1,c(-5,-6)],shade=TRUE)
```
<br>
<span style="background-color: #FFFF00">b2. do barriers change by nbhd type? Gender? Attitudes towards nature? </span> <br>
The significance tests are included below:


```{r}
Q4.b21<-xtabs(~df.chi$neighbortype+Q5.7$total_barriers)
Q4.b21
CMHtest(Q4.b21)
sieve(Q4.b21[-5,c(-5,-6)],shade = TRUE)

Q4.b22<-xtabs(~df.chi$gender+Q5.7$total_barriers)
Q4.b22
CMHtest(Q4.b22)

Q4.b23<-xtabs(~df.cor$naturefeel+Q5.7$total_barriers)
Q4.b23
CMHtest(Q4.b23)

Q4.b24<-xtabs(~df.cor$nature_after_feel+Q5.7$total_barriers)
CMHtest(Q4.b24)
boxplot(df.cor$nature_after_feel~Q5.7$total_barriers)


```


## 5 Other questions
<span style="background-color: #FFFF00">a.	Who do they spend time with in nature (at home and at work and for both pre and post covid) and how did it change – within and across subjects? </span> <br>

Total types of companions are significantly fewer.
For each type of companion, the before and after are still correlated.
Workmates and friends are significantly decreasing during COVID. <br>

```{r}
Q3.3 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')

Q3.3.sum<-Q3.3 %>% 
  pivot_longer(myself_before:others_during,
               names_to = "people",
               values_to = "number") %>% 
  group_by(people) %>% 
  summarise_all(sum) 

Q3.3.sum%>% 
  ggplot(mapping = aes(x=people,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))

Q3.3.sum[,c(1,4)]

res2 <- t.test(Q3.3$total_before, Q3.3$total_during, paired = TRUE)
res2
boxplot(Q3.3$total_before, Q3.3$total_during)

Q5.a<-xtabs(~Q3.3$family_before+ Q3.3$family_during)
Q5.a
chisq.test(Q5.a)
sieve(Q5.a,shade = TRUE)

Q5.a2<-xtabs(~Q3.3$myself_before+ Q3.3$myself_during)
Q5.a2
chisq.test(Q5.a2)
sieve(Q5.a2,shade = TRUE)

Q5.a3<-xtabs(~Q3.3$friends_before+ Q3.3$friends_during)
Q5.a3
chisq.test(Q5.a3)
sieve(Q5.a3,shade = TRUE)

Q5.a4<-xtabs(~Q3.3$workmates_before+ Q3.3$workmates_during)
Q5.a4
chisq.test(Q5.a4)
sieve(Q5.a4,shade = TRUE)


```
<br><span style="background-color: #FFFF00">b.	What do they do outdoors (activities) - (at home and at work and for both pre and post covid) and how did it change – within and across subjects? </span> <br>

Q5.6 is about what typicaly do on campus, I don't know how to do the test now, may do it in the future.

```{r}
Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activities,y=number)) +
  geom_bar(stat="identity")

Q5.6.sum<-Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum)

Q5.6.sum[,c(1,3)]
```
Q 3.2 is asking what activities typically do before and during covid?<br>

Total number of types of activities is signifianctly decreasing but the amount is not large (0.2). 
Restorative activities are increasing while social activities are decreasing during the COVID.
```{r}
Q3.2 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')
Q3.2 %>% 
  pivot_longer(social_before:others_during,
               names_to = "activity",
               values_to = "number") %>% 
  group_by(activity) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activity,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))

res3 <- t.test(Q3.2$total_before, Q3.2$total_during, paired = TRUE)
res3
boxplot(Q3.2$total_before, Q3.2$total_during)
mean(Q3.2$total_before)- mean(Q3.2$total_during)

```

<span style="background-color: #FFFF00">c.	Why do they spend time outdoors in nature, and how did this change during covid (Q4.2)<br>
c1.	Correlation between WHY and time outdoors<br>
c2.	How do reasons for spending time outdoors intersect with:<br>
i.	Who they spent time with
ii.	barriers</span> <br>

The total number of reasons for spending time outdoors is not change.
The c1 and c2 questions are difficult for me and I need help from Statistics.

```{r}
Q4.2 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')

Q4.2.sum<-Q4.2 %>% 
  pivot_longer(exercise_before:others_during,
               names_to = "reasons",
               values_to = "number") %>% 
  group_by(reasons) %>% 
  summarise_all(sum) 

Q4.2.sum%>% 
  ggplot(mapping = aes(x=reasons,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))

Q4.2.sum[,c(1,4)]

res4 <- t.test(Q4.2$total_before, Q4.2$total_during, paired = TRUE)
res4
```

<span style="background-color: #FFFF00">d.	Is there a connection between people’s motivation for  spending time in nature (Q4.2) attitudes towards nature (Q4.4) OR perceived benefits (Q4.3) and time spent outdoors [both per and post covid] (Q2.5 to 2.10) – does this differ for any demographic groups </span> <br>

Hope to get answers for this complex questions from Statistics Consulting.

```{r}

```

<span style="background-color: #FFFF00">
e.	By neighborhood type are there changes in the number and type of places used pre to post covid, and within and across subjects</span> <br>


The total number of change is not correlated with neighborhood.

```{r}
usechange<-Q2.4.score$use.score.after-Q2.4.score$use.score.before
Q5.e<-xtabs(~df.chi$neighbortype+usechange)
Q5.e
CMHtest(Q5.e)
```

<span style="background-color: #FFFF00"> f.	Is there increased contact with nature as a result of covid?
A difficult question.<br>
g.	More using outdoors early in the pandemic versus Fall 2020, and Fall 2020 went somewhat back to Fall 2019 levels
g1.	What does this intersect with – attitudes?</span> <br>

NOT done yet.

```{r}

```

