---
title: "Nature Use Survey Analysis"
author: "Wangda Zhu"
date: "`r Sys.Date()`"
output:
   html_document:
     theme: "spacelab"
     toc: TRUE
     toc_float: TRUE
     fig_height: 4
     fig_width: 4
     fig_align: 'center'
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Workflow

This is a workflow of analyzing survey data from Qualtrics. When exporting data from Qualtrics, make sure to select "Use choice text" and "Split multi-value fields into columns" and export the data as csv file. 

After downloading the file, open it and delete the first **two rows** of the raw data. Now you should have the spreadsheet with only one row as its head. This will give convenience to further data wrangling in R. 

## Import useful libraries and read the raw data to R

```{r}
library(tidyverse)

raw<-read_csv("rawdata2.csv")
names(raw)<-str_replace_all(names(raw), c("#" = "."))
colnames(raw)[5]<-"Duration"
colnames(raw)[9]<-"Distribution"
raw$StartDate<-as.Date(raw$StartDate,format='%m/%d/%y')
```

## Filter the valid sample by progress, distribution, duration and startdate
```{r}
raw<-raw[raw$StartDate>"2020-11-23",]
raw<-raw[raw$Progress>70 & raw$Duration>180 & raw$Distribution != "preview",]

```

## 1 we create new dataframes for each multichoice questions and count the number of checked boxes
```{r}
#Q2.3 nature access
Q2.3<- raw %>% 
  select(contains( "Q2.3")) %>% 
  mutate(private=ifelse(is.na(Q2.3_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.3_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.3_5),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.3_7),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.3_8),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.3_9),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.3_10),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.3_11),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.3_14),0,1)) %>% 
  mutate(other=ifelse(is.na(Q2.3_14),0,1)) %>% 
  select(-contains("Q2.3")) %>% 
  mutate(access.score=private+deck+public+botanical+nature+woodland+river+lake+other)
Q2.3<-Q2.3 %>% 
  mutate(outdoorsathome=private+deck) %>% 
  mutate(outdoorsnearhome=(public+botanical+nature+woodland+river+lake+other)) %>% 
  mutate(divesitynearhome=ifelse(outdoorsnearhome>=3,1,0))

#Q2.4 nature use type before and after
Q2.4.before<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=ifelse(is.na(Q2.4.1_1_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.4.1_2_1),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.4.1_3_1),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.4.1_4_1),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.4.1_5_1),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.4.1_6_1),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.4.1_7_1),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.4.1_8_1),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.4.1_10_1),0,1)) %>% 
  select(-contains("Q2.4")) %>% 
  mutate(use.score.before=private+deck+public+botanical+nature+woodland+river+lake)

Q2.4.after<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=ifelse(is.na(Q2.4.1_1_2),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.4.1_2_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.4.1_3_2),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.4.1_4_2),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.4.1_5_2),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.4.1_6_2),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.4.1_7_2),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.4.1_8_2),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.4.1_10_2),0,1)) %>% 
  select(-contains("Q2.4")) %>% 
  mutate(use.score.after=private+deck+public+botanical+nature+woodland+river+lake)

#Q3.2 nature use activity before and after
Q3.2<- raw %>% 
  select(contains( "Q3.2")) %>% 
  mutate(social_before=ifelse(is.na(Q3.2_1_1),0,1)) %>% 
  mutate(social_during=ifelse(is.na(Q3.2_1_2),0,1)) %>% 
  mutate(lowintensity_before=ifelse(is.na(Q3.2_2_1),0,1)) %>% 
  mutate(lowintensity_during=ifelse(is.na(Q3.2_2_2),0,1)) %>% 
  mutate(highintensity_before=ifelse(is.na(Q3.2_3_1),0,1)) %>% 
  mutate(highintensity_during=ifelse(is.na(Q3.2_3_2),0,1)) %>% 
  mutate(restorative_before=ifelse(is.na(Q3.2_4_1),0,1)) %>% 
  mutate(restorative_during=ifelse(is.na(Q3.2_4_2),0,1)) %>% 
  mutate(others_before=ifelse(is.na(Q3.2_5_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q3.2_5_2),0,1)) %>% 
  select(-contains("Q3.2")) %>% 
  mutate(total_before=social_before + lowintensity_before + highintensity_before + restorative_before + others_before) %>% 
  mutate(total_during=social_during + lowintensity_during + highintensity_during + restorative_during + others_during) 

#Q3.3 nature use companion before and after
Q3.3<- raw %>% 
  select(contains( "Q3.3")) %>% 
  mutate(myself_before=ifelse(is.na(Q3.3_1_1),0,1)) %>% 
  mutate(myself_during=ifelse(is.na(Q3.3_1_2),0,1)) %>% 
  mutate(family_before=ifelse(is.na(Q3.3_2_1),0,1)) %>% 
  mutate(family_during=ifelse(is.na(Q3.3_2_2),0,1)) %>% 
  mutate(friends_before=ifelse(is.na(Q3.3_3_1),0,1)) %>% 
  mutate(friends_during=ifelse(is.na(Q3.3_3_2),0,1)) %>% 
  mutate(workmates_before=ifelse(is.na(Q3.3_4_1),0,1)) %>% 
  mutate(workmates_during=ifelse(is.na(Q3.3_4_2),0,1)) %>% 
  mutate(others_before=ifelse(is.na(Q3.3_5_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q3.3_5_2),0,1)) %>% 
  select(-contains("Q3.3")) %>% 
  mutate(total_before=myself_before + family_before + friends_before + workmates_before + others_before) %>% 
  mutate(total_during=myself_during + family_during + friends_during + workmates_during + others_during)

#Q4.2 nature use reason before and after
Q4.2<- raw %>% 
  select(contains( "Q4.2")) %>% 
  mutate(exercise_before=ifelse(is.na(Q4.2_1_1),0,1)) %>% 
  mutate(exercise_during=ifelse(is.na(Q4.2_1_2),0,1)) %>% 
  mutate(stressrelief_before=ifelse(is.na(Q4.2_2_1),0,1)) %>% 
  mutate(stressrelief_during=ifelse(is.na(Q4.2_2_2),0,1)) %>% 
  mutate(fun_before=ifelse(is.na(Q4.2_3_1),0,1)) %>% 
  mutate(fun_during=ifelse(is.na(Q4.2_3_2),0,1)) %>% 
  mutate(nature_before=ifelse(is.na(Q4.2_4_1),0,1)) %>% 
  mutate(nature_during=ifelse(is.na(Q4.2_4_2),0,1)) %>% 
  mutate(family_before=ifelse(is.na(Q4.2_5_1),0,1)) %>% 
  mutate(family_during=ifelse(is.na(Q4.2_5_2),0,1)) %>% 
  mutate(friends_before=ifelse(is.na(Q4.2_6_1),0,1)) %>%
  mutate(friends_during=ifelse(is.na(Q4.2_6_2),0,1)) %>%
  mutate(others_before=ifelse(is.na(Q4.2_7_1),0,1)) %>% 
  mutate(others_during=ifelse(is.na(Q4.2_7_2),0,1)) %>% 
  select(-contains("Q4.2")) %>% 
  mutate(total_before=exercise_before + stressrelief_before + fun_before + nature_before +friends_before + family_before+ others_before) %>% 
  mutate(total_during=exercise_during + stressrelief_during + fun_during + nature_during +friends_during + family_during+ others_during)

#Q4.5 nature access barriers
Q4.5<- raw %>% 
  select(contains( "Q4.5")) %>% 
  mutate(notime=ifelse(is.na(Q4.5_3),0,1)) %>% 
  mutate(noaccess=ifelse(is.na(Q4.5_4),0,1)) %>% 
  mutate(unsafe=ifelse(is.na(Q4.5_7),0,1)) %>% 
  mutate(noones=ifelse(is.na(Q4.5_8),0,1)) %>% 
  mutate(others=ifelse(is.na(Q4.5_9),0,1)) %>% 
  select(-contains("Q4.5")) %>% 
  mutate(total_barries=notime + noaccess + unsafe + noones + others) 

#Q5.6 nature work use activity
Q5.6<- raw %>% 
  select(contains( "Q5.6")) %>% 
  mutate(eat=ifelse(is.na(Q5.6_1),0,1)) %>% 
  mutate(walk=ifelse(is.na(Q5.6_2),0,1)) %>% 
  mutate(meet=ifelse(is.na(Q5.6_3),0,1)) %>% 
  mutate(rest=ifelse(is.na(Q5.6_4),0,1)) %>% 
  mutate(others=ifelse(is.na(Q5.6_5),0,1)) %>% 
  select(-contains("Q5.6")) %>% 
  mutate(total_campusoutdoors=eat + walk + meet + rest + others) 

#Q5.7 nature work access barrier
Q5.7<- raw %>% 
  select(contains( "Q5.7")) %>% 
  mutate(nointerest=ifelse(is.na(Q5.7_1),0,1)) %>% 
  mutate(notime=ifelse(is.na(Q5.7_2),0,1)) %>% 
  mutate(discouraged=ifelse(is.na(Q5.7_3),0,1)) %>% 
  mutate(noaccess=ifelse(is.na(Q5.7_4),0,1)) %>% 
  mutate(unappealing=ifelse(is.na(Q5.7_9),0,1)) %>% 
  mutate(noprotect=ifelse(is.na(Q5.7_10),0,1)) %>% 
  mutate(others=ifelse(is.na(Q5.7_11),0,1)) %>% 
  select(-contains("Q5.7")) %>% 
  mutate(total_barriers=nointerest+notime+discouraged+noaccess+unappealing+noprotect + others) 

#Q6.2 household
Q6.2<- raw %>% 
  select(contains( "Q6.2")) %>% 
  mutate(self=ifelse(is.na(Q6.2_10),0,1)) %>% 
  mutate(childpre=ifelse(is.na(Q6.2_1),0,1)) %>% 
  mutate(childele=ifelse(is.na(Q6.2_2),0,1)) %>% 
  mutate(youthmiddle=ifelse(is.na(Q6.2_3),0,1)) %>% 
  mutate(youthhigh=ifelse(is.na(Q6.2_4),0,1)) %>% 
  mutate(partner=ifelse(is.na(Q6.2_5),0,1)) %>% 
  mutate(parents=ifelse(is.na(Q6.2_6),0,1)) %>% 
  mutate(otherfamily=ifelse(is.na(Q6.2_7),0,1)) %>% 
  mutate(friend=ifelse(is.na(Q6.2_8),0,1)) %>% 
  mutate(others=ifelse(is.na(Q6.2_9),0,1)) %>% 
  select(-contains("Q6.2")) %>% 
  mutate(total_household=childpre+childele+youthhigh+youthmiddle+partner+parents+otherfamily+friend + others) %>% 
  mutate(children=(childpre==1|childele==1|youthmiddle==1|youthhigh==1)) 

# Q6.4 family outdoor activities
Q6.4<- raw %>% 
  select(contains( "Q6.4")) %>% 
  mutate(walking=ifelse(is.na(Q6.4_2),0,1)) %>% 
  mutate(running=ifelse(is.na(Q6.4_3),0,1)) %>% 
  mutate(kayaking=ifelse(is.na(Q6.4_5),0,1)) %>% 
  mutate(gardening=ifelse(is.na(Q6.4_6),0,1)) %>% 
  mutate(relaxing=ifelse(is.na(Q6.4_7),0,1)) %>% 
  mutate(camping=ifelse(is.na(Q6.4_9),0,1)) %>% 
  mutate(fishing=ifelse(is.na(Q6.4_10),0,1)) %>% 
  mutate(others=ifelse(is.na(Q6.4_11),0,1)) %>% 
  select(-contains("Q6.4")) %>% 
  mutate(total_familyoutdoors=walking+running+kayaking+gardening+relaxing+camping+fishing + others) 

```
## 2 we recode some variables and group them with the same measurement
```{r warning=FALSE}
#time natureQ2.4, Q2.6, Q2.7, Q2.8, Q2.10
timeoutdoors<- raw %>% 
  dplyr:: select(contains(c("2.5", "2.6", "2.7","2.8", "2.10"))) %>% 
  mutate_at(vars(1),function(x)(dplyr::recode(x,"7 days"=7, "4-6 days" = 5,
                                                "2-3 days" = 2.5,"1 day" = 1,
                                                "No days" = 0))) %>% 
  mutate_at(vars(2),function(x)(dplyr::recode(x,"More than 1 hr"=60, "31min - 1hr" = 45,
                                              "15-30 min" = 22.5,"Less than 15 min" = 7.5)))

#Q4.3 How you feel after time in nature
Q4.3<- raw %>% 
  select(contains("4.3")) %>% 
  mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                "Strongly disagree" = 1))) 
Q4.3$score=rowMeans(cbind(Q4.3$Q4.3_1,Q4.3$Q4.3_2,Q4.3$Q4.3_3,Q4.3$Q4.3_4,Q4.3$Q4.3_5),na.rm = TRUE)

#Q4.4 – How do you generally feel about nature
Q4.4<- raw %>% 
  select(contains("4.4")) %>% 
  mutate_at(vars(1:3),function(x)(dplyr::recode(x,"Not at all"=0, "Somewhat" = 1,
                                                "Definitely" = 3))) 
Q4.4$score=rowMeans(cbind(Q4.4$Q4.4_1,Q4.4$Q4.4_2,Q4.4$Q4.4_3),na.rm = TRUE)

#Q6.5 Spending time with family in nature
Q6.5<- raw %>% 
  select(contains("6.5")) %>% 
  mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                "Strongly disagree" = 1))) 
Q6.5$score=rowMeans(cbind(Q6.5$Q6.5_1,Q6.5$Q6.5_2,Q6.5$Q6.5_3),na.rm = TRUE)

Q7.7_access<- raw %>% 
  mutate(private=ifelse(is.na(Q2.3_1),0,1)) %>% 
  mutate(deck=ifelse(is.na(Q2.3_2),0,1)) %>% 
  mutate(public=ifelse(is.na(Q2.3_5),0,1)) %>% 
  mutate(botanical=ifelse(is.na(Q2.3_7),0,1)) %>% 
  mutate(nature=ifelse(is.na(Q2.3_8),0,1)) %>% 
  mutate(woodland=ifelse(is.na(Q2.3_9),0,1)) %>% 
  mutate(river=ifelse(is.na(Q2.3_10),0,1)) %>% 
  mutate(lake=ifelse(is.na(Q2.3_11),0,1)) %>% 
  mutate(other=ifelse(is.na(Q2.3_13),0,1)) %>% 
  mutate(none=ifelse(is.na(Q2.3_14),0,1)) %>% 
  mutate(access.score=private+deck+public+botanical+nature+woodland+river+lake+other) %>% 
  select(contains("Q7.7"),access.score) 
Q7.7_access<- Q7.7_access %>% 
  mutate(neighborhood=dplyr::recode(Q7.7,"Larger city or urban center (e.g., Syracuse, NYC)"=5, 
                                              "Smaller city or urban center (e.g. Ithaca, Elmira)" = 4,
                                              "Suburb or just outside an urban center (e.g, Cayuga Heights, East Ithaca)" = 3,
                                              "Small town or village (e.g., Trumansburg, Lansing)" = 2,
                                              "Rural area" = 1))

# Q7.8 – Ethnicity / race
Q7.8<- raw %>% 
  select(contains( "Q7.8")) %>% 
  mutate(race2=case_when(is.na(Q7.8_1)==FALSE | is.na(Q7.8_2)==FALSE | is.na(Q7.8_3)==FALSE ~ "1",
                           is.na(Q7.8_4)==FALSE | is.na(Q7.8_5)==FALSE ~ "2",
                           is.na(Q7.8_6)==FALSE  ~ "3",
                           is.na(Q7.8_7)==FALSE  ~ "4",
                           is.na(Q7.8_8)==FALSE ~ "NA")) %>% 
  mutate(race1=case_when(is.na(Q7.8_1)==FALSE ~ "1",
                         is.na(Q7.8_2)==FALSE~ "2",
                         is.na(Q7.8_3)==FALSE~ "3",
                        is.na(Q7.8_4)==FALSE  ~ "4",
                        is.na(Q7.8_5)==FALSE~ "5",
                        is.na(Q7.8_6)==FALSE  ~ "6",
                        is.na(Q7.8_7)==FALSE  ~ "7",
                        is.na(Q7.8_8)==FALSE ~ "NA")) %>% 
  select(-contains("Q7.8")) %>% 
  mutate_if(is.character, as.factor)

```
## 3 we visulize some basic data
```{r warning=FALSE}
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(access.score))) +
  geom_bar(stat="count",position='dodge')
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsathome))) +
  geom_bar(stat="count",position='dodge') 
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(outdoorsnearhome))) +
  geom_bar(stat="count",position='dodge') 
Q2.3 %>% 
  ggplot(mapping = aes(x=as.factor(divesitynearhome))) +
  geom_bar(stat="count",position='dodge') 

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.7))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Weekend days – compared to weekdays ")

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.8))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Fall 2020 Vs April-July2020")

timeoutdoors %>% 
  ggplot(mapping = aes(x=as.factor(Q2.10))) +
  geom_bar(stat="count",position='dodge')+
  xlab("Fall 2020 Vs Fall 2019")
Q3.2 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')
Q3.2 %>% 
  pivot_longer(social_before:others_during,
               names_to = "activity",
               values_to = "number") %>% 
  group_by(activity) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activity,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))

Q3.3 %>% 
  pivot_longer(total_before:total_during,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=time)) +
  geom_bar(stat="count",position='dodge')

Q3.3 %>% 
  pivot_longer(myself_before:others_during,
               names_to = "people",
               values_to = "number") %>% 
  group_by(people) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=people,y=number)) +
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(size=10,angle = 90,hjust=.5,vjust=.5,face="plain"))
Q5.6 %>% 
  pivot_longer(eat:others,
               names_to = "activities",
               values_to = "number") %>% 
  group_by(activities) %>% 
  summarise_all(sum) %>% 
  ggplot(mapping = aes(x=activities,y=number)) +
  geom_bar(stat="identity")


```

## 4 we visulize before and after multi choice questions, we take Q2.4 for example
```{r}
Q2.4<- raw %>% 
  select(contains( "Q2.4")) %>% 
  mutate(private=case_when(is.na(Q2.4.1_1_1)==TRUE & is.na(Q2.4.1_1_2)==TRUE ~ 1,
                           is.na(Q2.4.1_1_1)==TRUE & is.na(Q2.4.1_1_2)==FALSE ~ 2,
                           is.na(Q2.4.1_1_1)==FALSE & is.na(Q2.4.1_1_2)==TRUE ~ 3,
                           is.na(Q2.4.1_1_1)==FALSE & is.na(Q2.4.1_1_2)==FALSE ~ 4)) %>% 
  mutate(deck=case_when(is.na(Q2.4.1_2_1)==TRUE & is.na(Q2.4.1_2_2)==TRUE ~ 1,
                           is.na(Q2.4.1_2_1)==TRUE & is.na(Q2.4.1_2_2)==FALSE ~ 2,
                           is.na(Q2.4.1_2_1)==FALSE & is.na(Q2.4.1_2_2)==TRUE ~ 3,
                           is.na(Q2.4.1_2_1)==FALSE & is.na(Q2.4.1_2_2)==FALSE ~ 4)) %>% 
  mutate(public=case_when(is.na(Q2.4.1_3_1)==TRUE & is.na(Q2.4.1_3_2)==TRUE ~ 1,
                           is.na(Q2.4.1_3_1)==TRUE & is.na(Q2.4.1_3_2)==FALSE ~ 2,
                           is.na(Q2.4.1_3_1)==FALSE & is.na(Q2.4.1_3_2)==TRUE ~ 3,
                           is.na(Q2.4.1_3_1)==FALSE & is.na(Q2.4.1_3_2)==FALSE ~ 4)) %>% 
  mutate(botanical=case_when(is.na(Q2.4.1_4_1)==TRUE & is.na(Q2.4.1_4_2)==TRUE ~ 1,
                           is.na(Q2.4.1_4_1)==TRUE & is.na(Q2.4.1_4_2)==FALSE ~ 2,
                           is.na(Q2.4.1_4_1)==FALSE & is.na(Q2.4.1_4_2)==TRUE ~ 3,
                           is.na(Q2.4.1_4_1)==FALSE & is.na(Q2.4.1_4_2)==FALSE ~ 4)) %>% 
  mutate(nature=case_when(is.na(Q2.4.1_5_1)==TRUE & is.na(Q2.4.1_5_2)==TRUE ~ 1,
                           is.na(Q2.4.1_5_1)==TRUE & is.na(Q2.4.1_5_2)==FALSE ~ 2,
                           is.na(Q2.4.1_5_1)==FALSE & is.na(Q2.4.1_5_2)==TRUE ~ 3,
                           is.na(Q2.4.1_5_1)==FALSE & is.na(Q2.4.1_5_2)==FALSE ~ 4)) %>% 
  mutate(woodland=case_when(is.na(Q2.4.1_6_1)==TRUE & is.na(Q2.4.1_6_2)==TRUE ~ 1,
                           is.na(Q2.4.1_6_1)==TRUE & is.na(Q2.4.1_6_2)==FALSE ~ 2,
                           is.na(Q2.4.1_6_1)==FALSE & is.na(Q2.4.1_6_2)==TRUE ~ 3,
                           is.na(Q2.4.1_6_1)==FALSE & is.na(Q2.4.1_6_2)==FALSE ~ 4)) %>% 
  mutate(river=case_when(is.na(Q2.4.1_7_1)==TRUE & is.na(Q2.4.1_7_2)==TRUE ~ 1,
                           is.na(Q2.4.1_7_1)==TRUE & is.na(Q2.4.1_7_2)==FALSE ~ 2,
                           is.na(Q2.4.1_7_1)==FALSE & is.na(Q2.4.1_7_2)==TRUE ~ 3,
                           is.na(Q2.4.1_7_1)==FALSE & is.na(Q2.4.1_7_2)==FALSE ~ 4)) %>% 
  mutate(lake=case_when(is.na(Q2.4.1_8_1)==TRUE & is.na(Q2.4.1_8_2)==TRUE ~ 1,
                           is.na(Q2.4.1_8_1)==TRUE & is.na(Q2.4.1_8_2)==FALSE ~ 2,
                           is.na(Q2.4.1_8_1)==FALSE & is.na(Q2.4.1_8_2)==TRUE ~ 3,
                           is.na(Q2.4.1_8_1)==FALSE & is.na(Q2.4.1_8_2)==FALSE ~ 4)) %>% 
  mutate(none=case_when(is.na(Q2.4.1_10_1)==TRUE & is.na(Q2.4.1_10_2)==TRUE ~ 1,
                           is.na(Q2.4.1_10_1)==TRUE & is.na(Q2.4.1_10_2)==FALSE ~ 2,
                           is.na(Q2.4.1_10_1)==FALSE & is.na(Q2.4.1_10_2)==TRUE ~ 3,
                           is.na(Q2.4.1_10_1)==FALSE & is.na(Q2.4.1_10_2)==FALSE ~ 4)) %>% 
  select(-contains("Q2.4"))

Q2.4 %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "change") %>% 
  mutate(change=factor(change,labels = c("NbeforeNnow", "beforeNnow","Nbeforenow","beforenow"))) %>% 
  ggplot(mapping = aes(x=place,fill=change)) +
    geom_bar(stat="count",position='dodge')
Q2.4.score<-cbind(Q2.4.before,Q2.4.after)

Q2.4.score %>% 
  select(use.score.before,use.score.after) %>% 
  pivot_longer(use.score.before:use.score.after,
               names_to = "time",
               values_to = "number") %>% 
  ggplot(mapping = aes(x=number,fill=factor(time,levels = c("use.score.before","use.score.after")))) +
  geom_bar(stat="count",position='dodge')+
  guides(fill=guide_legend(title="Time"))+ 
  ggtitle("Plot of total types of place use before and after COVID")

Q2.4.before<-Q2.4.before %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "use") %>% 
  group_by(place) %>%
  summarise(se = sd(use)/sqrt(483),total = sum(use)) %>% 
  mutate(time="before")

Q2.4.after<-Q2.4.after %>% 
  pivot_longer(private:none,
               names_to = "place",
               values_to = "use") %>% 
  group_by(place) %>%
  summarise(se = sd(use)/sqrt(483),total = sum(use)) %>% 
  mutate(time="after")

Q2.4.sum<-rbind(Q2.4.before,Q2.4.after)
levels<-unique(Q2.4.sum$place)
Q2.4.sum$place<-factor(Q2.4.sum$place,levels = c("botanical","deck","lake","nature","private","public","river","woodland","none"))
Q2.4.sum %>% 
  ggplot(mapping = aes(x=place,y=total/483,fill=factor(time,levels = c("before","after")))) +
  geom_bar(stat="identity",position='dodge')+
  geom_errorbar(aes(ymin=total/483-se, ymax=total/483+se), width=.5,
                position=position_dodge(.9)) +
  ylab("proportion")+
  guides(fill=guide_legend(title="Time"))+ 
  ggtitle("Plot of place use before and after COVID")

###Let's focus on the change: who change most after covid?
Q2.4.score %>% 
  select(use.score.before,use.score.after) %>%
  mutate(change=use.score.after-use.score.before) %>% 
  select(change) %>% 
  mutate(id = row_number()) %>% 
  ggplot(mapping = aes(x = id,y=change))+
  geom_bar(stat = "identity")

Q2.4_demo<-Q2.4.score %>% 
  select(use.score.before,use.score.after) %>%
  mutate(change=use.score.after-use.score.before) %>% 
  select(change) %>% 
  mutate(id = row_number()) %>% 
  mutate(largechange=ifelse(change>2 | change <(-2),1,0)) %>% 
  mutate(changedirection=case_when(change>0~"positive",
                                   change==0~"nochange",
                                   change<0~"negative")) %>% 
  cbind("neighborhood"=raw$Q7.7) %>% 
  cbind("gender"= raw$Q7.2) %>% 
  cbind("workplace"=raw$Q5.3) %>% 
  cbind("workyear"= raw$Q7.3)


Q2.4_demo %>% ggplot(mapping = aes(x=neighborhood,fill=factor(largechange)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=neighborhood,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=gender,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")
Q2.4_demo %>% ggplot(mapping = aes(x=workplace,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")+
  theme(axis.text.x = element_text(size=10,angle = 20,hjust=.5,vjust=.5,face="plain"))
Q2.4_demo %>% ggplot(mapping = aes(x=workyear,fill=factor(changedirection)))+
  geom_bar(stat="count",position = "dodge")+
  theme(axis.text.x = element_text(size=10,angle = 20,hjust=.5,vjust=.5,face="plain"))

```

## 5 we do basic correlation calculation for continous, ordinal and binary data, there are different sorts of correlations between different types of variables
```{r warning=FALSE}
#correlatio between spend time outdoors during the workday,
#gender(0/1), how long at cornell, neighborhood type,
#household total, children, feel1, feel2, work barriers total, 
#time in nature, spend time outdoors during the workday
raw$Q5.2<-dplyr::recode(raw$Q5.2,"0 days"=0, "1 day"  = 1,
              "2-3 days" = 2,"4-5 days" = 3) 
raw$Q7.2<-dplyr::recode(raw$Q7.2,"Female"=0, "Male"  = 1)
raw$Q7.3<-dplyr::recode(raw$Q7.3,"Less than 2 years"=0, 
                        "More than 2 but less than 5 years"  = 1,
                        "More than 5 but less than 10 years" = 2,
                        "10 or more years" =3)
raw$Q7.7<-dplyr::recode(raw$Q7.7,"Larger city or urban center (e.g., Syracuse, NYC)"=1, 
                 "Smaller city or urban center (e.g. Ithaca, Elmira)" = 1,
                 "Suburb or just outside an urban center (e.g, Cayuga Heights, East Ithaca)" = 0,
                 "Small town or village (e.g., Trumansburg, Lansing)" = 0,
                 "Rural area" = 0)
Q6.2<- raw %>% 
    select(contains( "Q6.2")) %>% 
    mutate(self=ifelse(is.na(Q6.2_10),0,1)) %>% 
    mutate(childpre=ifelse(is.na(Q6.2_1),0,1)) %>% 
    mutate(childele=ifelse(is.na(Q6.2_2),0,1)) %>% 
    mutate(youthmiddle=ifelse(is.na(Q6.2_3),0,1)) %>% 
    mutate(youthhigh=ifelse(is.na(Q6.2_4),0,1)) %>% 
    mutate(partner=ifelse(is.na(Q6.2_5),0,1)) %>% 
    mutate(parents=ifelse(is.na(Q6.2_6),0,1)) %>% 
    mutate(otherfamily=ifelse(is.na(Q6.2_7),0,1)) %>% 
    mutate(friend=ifelse(is.na(Q6.2_8),0,1)) %>% 
    mutate(others=ifelse(is.na(Q6.2_9),0,1)) %>% 
    select(-contains("Q6.2")) %>% 
    mutate(total_household=childpre+childele+youthhigh+youthmiddle+partner+parents+otherfamily+friend + others) %>% 
    mutate(children=(childpre==1|childele==1|youthmiddle==1|youthhigh==1)) 
Q6.2$children<-ifelse(Q6.2$children==TRUE,1,0)
Q4.3<- raw %>% 
    select(contains("4.3")) %>% 
    mutate_at(vars(1:5),function(x)(dplyr::recode(x,"Strongly agree"=5, "Somewhat agree" = 4,
                                                  "Neither agree nor disagree" = 3,"Somewhat disagree" = 2,
                                                  "Strongly disagree" = 1))) 
Q4.3$score=rowMeans(cbind(Q4.3$Q4.3_1,Q4.3$Q4.3_2,Q4.3$Q4.3_3,Q4.3$Q4.3_4,Q4.3$Q4.3_5),na.rm = TRUE)
Q4.4<- raw %>% 
    select(contains("4.4")) %>% 
    mutate_at(vars(1:3),function(x)(dplyr::recode(x,"Not at all"=0, "Somewhat" = 1,
                                                  "Definitely" = 3))) 
Q4.4$score=rowMeans(cbind(Q4.4$Q4.4_1,Q4.4$Q4.4_2,Q4.4$Q4.4_3),na.rm = TRUE)
Q5.7<- raw %>% 
    select(contains( "Q5.7")) %>% 
    mutate(nointerest=ifelse(is.na(Q5.7_1),0,1)) %>% 
    mutate(notime=ifelse(is.na(Q5.7_2),0,1)) %>% 
    mutate(discouraged=ifelse(is.na(Q5.7_3),0,1)) %>% 
    mutate(noaccess=ifelse(is.na(Q5.7_4),0,1)) %>% 
    mutate(unappealing=ifelse(is.na(Q5.7_9),0,1)) %>% 
    mutate(noprotect=ifelse(is.na(Q5.7_10),0,1)) %>% 
    mutate(others=ifelse(is.na(Q5.7_11),0,1)) %>% 
    select(-contains("Q5.7")) %>% 
    mutate(total_barriers=nointerest+notime+discouraged+noaccess+unappealing+noprotect + others) 

raw$Q2.5<-dplyr::recode(raw$Q2.5,"7 days"=4, "4-6 days" = 3,
                                            "2-3 days" = 2,"1 day" = 1,
                                            "No days" = 0)
raw$Q2.6<-dplyr::recode(raw$Q2.6,"More than 1 hr"=3, "31min - 1hr" = 2,
                                  "15-30 min" = 1,"Less than 15 min" = 0)
df.cor<-as.data.frame(cbind(raw$Q5.2,raw$Q7.2,raw$Q7.3,raw$Q7.7,Q6.2$total_household,Q6.2$children,Q4.4$score,Q4.3$score,Q5.7$total_barriers,raw$Q2.5,raw$Q2.6))
colnames(df.cor)<-c("out_week","gender","workyrs","neighbor","household","children","naturefeel","nature_after_feel","barriers","week_out","out_time")
round(cor(df.cor,use="pairwise.complete.obs"),digits =3)
ltm::rcor.test(df.cor,use="pairwise.complete.obs")

```
## 6 we do basic statistic tests for norminal,ordinal and binary data such as chi2 test
```{r warning=FALSE}
# Q1
#CORRELATION BETWEEN ORDINAL AND ORDINAL
#                    ORDINAL AND NORMINAL
#                    NORMINAL AND NORMINAL
#1. CHI-2 TEST CAN BE USED
# We check space use and space access

df.chi<-Q2.3 %>% 
  select(access.score,outdoorsathome,outdoorsnearhome,divesitynearhome) %>% 
  mutate(access.score=as.factor(access.score)) %>% 
  rename(access=access.score) %>% 
  mutate(outdoorsathome=as.factor(outdoorsathome)) %>% 
  mutate(outdoorsnearhome=as.factor(outdoorsnearhome)) %>% 
  mutate(divesitynearhome=as.factor(divesitynearhome)) %>% 
  cbind("use.types.before"=as.factor(Q2.4.score$use.score.before)) %>% 
  cbind("use.types.after"=as.factor(Q2.4.score$use.score.after)) %>% 
  cbind("neighborhood"=as.factor(raw$Q7.7)) %>% 
  cbind("gender"= as.factor(raw$Q7.2)) %>% 
  cbind("workyear"= as.factor(raw$Q7.3)) %>% 
  cbind("use.activities.before"= as.factor(Q3.2$total_before)) %>% 
  cbind("use.activities.after"= as.factor(Q3.2$total_during)) %>% 
  cbind("use.companions.before"= as.factor(Q3.3$total_before)) %>% 
  cbind("use.companions.after"= as.factor(Q3.3$total_during)) %>%
  cbind("time.daysperweek"=as.factor(raw$Q2.5)) %>% 
  cbind("time.hourspertime"=as.factor(raw$Q2.6)) %>% 
  cbind("race1"=Q7.8$race1) %>% 
  cbind("race2"=Q7.8$race2)
  
  
#access  
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -1], MoreArgs=list(df.chi[,1]))
#outdoorsathome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -2], MoreArgs=list(df.chi[,2]))
#outdoorsnearhome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -3], MoreArgs=list(df.chi[,3]))
#divesitynearhome
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -4], MoreArgs=list(df.chi[,4]))
#neighborhood
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -7], MoreArgs=list(df.chi[,7]))
#gender
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -8], MoreArgs=list(df.chi[,8]))
#time week
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -14], MoreArgs=list(df.chi[,14]))
#time hour
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi[, -15], MoreArgs=list(df.chi[,15]))

# We check work/campus based space use

df.chi2<-Q5.6 %>% 
  select(total_campusoutdoors) %>% 
  mutate(total_campusoutdoors=as.factor(total_campusoutdoors)) %>% 
  cbind("timeinworkday"=as.factor(raw$Q5.2)) %>% 
  cbind("use.types.before"=as.factor(Q2.4.score$use.score.before)) %>% 
  cbind("use.types.after"=as.factor(Q2.4.score$use.score.after)) %>% 
  cbind("neighborhood"=as.factor(raw$Q7.7)) %>% 
  cbind("gender"= as.factor(raw$Q7.2)) %>% 
  cbind("workyear"= as.factor(raw$Q7.3)) %>% 
  cbind("use.activities.before"= as.factor(Q3.2$total_before)) %>% 
  cbind("use.activities.after"= as.factor(Q3.2$total_during)) %>% 
  cbind("use.companions.before"= as.factor(Q3.3$total_before)) %>% 
  cbind("use.companions.after"= as.factor(Q3.3$total_during)) %>%
  cbind("time.daysperweek"=as.factor(raw$Q2.5)) %>% 
  cbind("time.hourspertime"=as.factor(raw$Q2.6)) %>% 
  cbind("race1"=Q7.8$race1) %>% 
  cbind("race2"=Q7.8$race2)

#total_campusoutdoors
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi2[, -1], MoreArgs=list(df.chi2[,1]))
#timeinworkday
mapply(function(x, y) chisq.test(x, y)$p.value, df.chi2[, -2], MoreArgs=list(df.chi2[,2]))


#2. TO CALCULATE THE COEFFICIENT: 
# Q2
#CORRELATION BETWEEN CONTINOUS VARIABLE AND ORDINAL, OR NORMINAL? 
#1. TO CALCULATE THE COEFFICENT:
#2. NEED THE ASSUMPTION THAT CONTINOUS VARIABLE IS NORMAL DISTRIBUTED?
                    
#correlation between continous and ordinal variables:
#Spearman correlation


#correlation between continous and categorical variables:
#point-biserial correlation 
#linear model


#correlation between continous and continous variables:
#pearson correlation


#correlation between ordinal and ordinal variables:
#Spearman rank correlation 


#correlation between ordinal and norminal variables:
#rank-biserial  correlation  


#correlation between norminal and norminal variables:
#Phi Correlation Coefficient
#chi2 test


```
## 7 we do reliability test for likert data
```{r}
psy::cronbach(Q4.3[,1:5])
psy::cronbach(Q4.4[,1:3])
```
## 8 we do more complex data modeling like factor analysis and structural equation modeling
```{r}
# library(lavaan)   
# library(lavaanPlot)
# 
# data.cfa<-as.data.frame(cbind(raw$Q7.7,Q5.7$total_barriers,Q2.3$access.score,Q4.3$score,Q4.4$score,Q4.2$total_before,Q4.2$total_during,Q3.2$total_before,Q3.3$total_before,Q2.4.before$use.score.before,Q3.2$total_during,Q3.3$total_during,Q2.4.after$use.score.after))
# colnames(data.cfa)<-c("nei_type","barrier","access_type","feel_nature","feel_afteruse","reason_bafore","reason_during","before_activity","before_companion","before_type","after_activity","after_companion","after_type")
# data.cfa$feel_afteruse<-round(data.cfa$feel_afteruse,1)
# 
# data.cfa<-na.omit(data.cfa)
#     
# cfa.model <- '
#               attitudes =~ feel_afteruse+feel_nature+reason_bafore+reason_during
#               usebefore =~ before_activity+before_companion+before_type
#               useafter =~ after_activity+after_companion+after_type
#               
#                before_type ~~       after_type 
#               feel_afteruse ~~      feel_nature
#               before_activity ~~   after_activity
#               
#                 '
# fit2_CFA <- cfa(cfa.model, data = data.cfa)
# modindices(fit2_CFA, minimum.value = 3.841, sort=TRUE, free.remove = FALSE)
# fitmeasures(fit2_CFA, c("chisq","df","pvalue","gfi","agfi","nfi","nnfi","cfi","rmsea","rmsea.ci.lower","rmsea.ci.upper","rmsea.pvalue","srmr", "ave"))
# lavaanPlot(model = fit2_CFA, coefs = TRUE, stand=TRUE)




```


